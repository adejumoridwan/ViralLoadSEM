---
title: "ViralLoaadSEM"
author: "Adejumo Ridwan Suleiman"
date: "`r Sys.Date()`"
output: pdf_document
---

#
```{r}
library(mvnormalTest)
library(lavaan)
library(dplyr)
library(tidyr)
library(lavaanPlot)
```

# Load the Data
```{r}
VL_data <- read_sav("C:/Users/User/Documents/ViralLoadSEM/Adherence.sav")

names(VL_data)
```

# Data Cleaning
```{r}
data <- VL_data %>% 
  select(Agecat, Sex, Durationcat2, ARTregimen, PreEACVLcat, 
         Forgot, Beliefs, Sideffects, PhysicalIllness, Substanceuse, Depression, Pillburden, LostRanout, Transport, Scheduling, DisclosureFear, Partner, DrugStock, Stigma,
         Education, Counselling, PeerSupport, Extendedpickup,
         PillBox, Calender, Incentives, ARVswallowing, PhoneCalls, SMS, Alarms) %>% 
  rename(AGE = Agecat,
         Dur = Durationcat2,
         ART = ARTregimen,
         PVL = PreEACVLcat,
         b1 = Forgot,
         b2 = Beliefs,
         b3 = Sideffects,
         b4 = PhysicalIllness,
         b5 = Substanceuse,
         b6 = Depression,
         b7 = Pillburden,
         b8 = LostRanout,
         b9 = Transport,
         b10 = Scheduling,
         b11 = DisclosureFear,
         b12 = Partner,
         b13 = DrugStock,
         b14 = Stigma,
         s1 = Education,
         s2 = Counselling,
         s3 = PeerSupport,
         s4 = Extendedpickup,
         t1 = PillBox,
         t2 = Calender,
         t3 = Incentives,
         t4 = ARVswallowing,
         t5 = PhoneCalls,
         t6 = SMS,
         t7 = Alarms) %>% 
  drop_na()
```

# Data Summary
```{r}
skimr::skim(data)
```

# Confirmatory Factor Analysis (CFA)
```{r}
cfa <- '  B =~ b1+b2+b3+b4+b5+b6+b7+b8+b9+b10+b11+b12+b13+b14 
          S =~ s1+s2+s3+s4 
          T =~ t1+t2+t3+t4+t5+t6+t7'
```



# Assession Assumptions(Shapiro-Wilk Univariate normality test)
```{r}
mvnout <- mardia(data)
mvnout$uv.shapiro
```

```{r}
mvnout$mv.test
```

# Model Specification

```{r}
cor(data, method = "pearson", use = "complete.obs")
```


```{r}
# Model Specification
model <- 'VLS =~ AGE + Sex + Dur + ART + PVL + B + I
          VLS ~ AGE + Sex + Dur + ART + PVL + B + I
          B =~ b1+b2+b3+b4+b5+b6+b7+b8+b9+b10+b11+b12+b13+b14 
          S =~ s1+s2+s3+s4 
          T =~ t1+t2+t3+t4+t5+t6+t7 
          I =~ S + T 
          b2 ~~ b10
          b14 ~~ b2
          t1 ~~ b2
          t7 ~~ b3
          t7 ~~ b4
          t4 ~~ b7
          t7 ~~ b8
          t6 ~~ b8
          t3 ~~ b8 
          b12 ~~ b10
          b14 ~~ b10
          t1 ~~ b10'
```


```{r}
model <- 'VLS =~ AGE + Sex + Dur + ART + PVL + B + I
          VLS ~ AGE + Sex + Dur + ART + PVL + B + I
          B =~ b1+b2+b3+b4+b5+b6+b7+b8+b9+b10+b11+b12+b13+b14 
          S =~ s1+s2+s3+s4 
          T =~ t1+t2+t3+t4+t5+t6+t7 
          I =~ S + T'

# SEM Function Syntax
fit <- sem(model, data=data, std.lv = TRUE, ordered = c(names(data)),check.gradient = FALSE)
```

```{r}
fitMeasures(fit, c("cfi.scaled", "srmr"))
```

# Model Fit

## Chi-Square
```{r}
fitMeasures(fit, c("chisq.scaled", "df.scaled", "pvalue.scaled"))
```

## RMSEA
```{r}
fitMeasures(fit, c("rmsea.scaled", "rmsea.ci.lower.scaled", "rmsea.ci.upper.scaled", "rmsea.pvalue.scaled"))
```

```{r}
summary(fit, fit.measures = TRUE, standardized=TRUE)
```

```{r}
lavaanPlot(model = fit)
```

